#!/bin/bash

# Define ANSI colors
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
ORANGE='\033[38;5;208m'
CYAN='\033[1;36m'
RESET='\033[0m'

# Highlight keywords in a line
highlight_line() {
    echo "$1" | sed -E \
        -e "s/(error)/${GREEN}\1${RESET}/Ig" \
        -e "s/(fail)/${YELLOW}\1${RESET}/Ig" \
        -e "s/(no such file or directory)/${ORANGE}\1${RESET}/Ig" \
        -e "s/(memory)/${CYAN}\1${RESET}/Ig"
}

# Process a single directory
process_directory() {
    local dir="$1"
    shopt -s nullglob
    log_files=("$dir"/*.log)

    for logfile in "${log_files[@]}"; do
        error_lines=()
        fail_lines=()

        while IFS= read -r line; do
            highlighted=$(highlight_line "$line")
            error_lines+=("$highlighted")
        done < <(grep -i 'error' "$logfile")

        while IFS= read -r line; do
            highlighted=$(highlight_line "$line")
            fail_lines+=("$highlighted")
        done < <(grep -i 'fail' "$logfile")

        if [[ ${#error_lines[@]} -gt 0 || ${#fail_lines[@]} -gt 0 ]]; then
            echo -e "In directory: $dir"
            echo -e "  Log file: $logfile"

            if [[ ${#error_lines[@]} -gt 0 ]]; then
                echo -e "    Matches for 'error':"
                for l in "${error_lines[@]}"; do
                    echo -e "      $l"
                done
            fi

            if [[ ${#fail_lines[@]} -gt 0 ]]; then
                echo -e "    Matches for 'fail':"
                for l in "${fail_lines[@]}"; do
                    echo -e "      $l"
                done
            fi

            echo
        fi
    done
}

# Find all directories and process each
find . -type d | while read -r subdir; do
    process_directory "$subdir"
done