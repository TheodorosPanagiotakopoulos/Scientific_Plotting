#!/bin/bash

# Function to highlight specific keywords in yellow
highlight_specific_terms() {
    sed -E \
        -e 's/(no such file or directory)/\x1b[1;33m\1\x1b[0m/Ig' \
        -e 's/(memory)/\x1b[1;33m\1\x1b[0m/Ig'
}

# Function to apply base color to entire line (for 'error' or 'fail'), then highlight terms
color_lines_with_highlights() {
    local color="$1"  # e.g., \x1b[1;32m for green, \x1b[1;33m for yellow
    grep -i "$2" "$3" | while IFS= read -r line; do
        highlighted=$(echo "$line" | highlight_specific_terms)
        echo -e "${color}${highlighted}\x1b[0m"
    done
}

# Function to process a single directory
process_directory() {
    local dir="$1"
    shopt -s nullglob
    log_files=("$dir"/*.log)

    for logfile in "${log_files[@]}"; do
        > /tmp/grep_error.tmp
        > /tmp/grep_fail.tmp

        color_lines_with_highlights $'\x1b[1;32m' 'error' "$logfile" > /tmp/grep_error.tmp
        color_lines_with_highlights $'\x1b[1;33m' 'fail' "$logfile" > /tmp/grep_fail.tmp

        if [[ -s /tmp/grep_error.tmp || -s /tmp/grep_fail.tmp ]]; then
            echo "In directory: $dir"
            echo "  Log file: $logfile"

            if [[ -s /tmp/grep_error.tmp ]]; then
                echo "    Matches for 'error':"
                cat /tmp/grep_error.tmp
            fi

            if [[ -s /tmp/grep_fail.tmp ]]; then
                echo "    Matches for 'fail':"
                cat /tmp/grep_fail.tmp
            fi

            echo
        fi

        rm -f /tmp/grep_error.tmp /tmp/grep_fail.tmp
    done
}

# Process all directories recursively
find . -type d | while read -r subdir; do
    process_directory "$subdir"
done